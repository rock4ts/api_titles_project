![titles_api workflow](https://github.com/rock4ts/titles_api_teamwork/actions/workflows/titles_workflow.yml/badge.svg?event=push)

# Titles API
## Описание
Django-проект API Titles собирает отзывы пользователей на произведения. Сами произведения в Titles не хранятся, здесь нельзя посмотреть фильм или послушать музыку.<br>
Произведения делятся на категории, такие как «Книги», «Фильмы», «Музыка».
Произведению может быть присвоен жанр из списка предустановленных (например, «Сказка», «Рок» или «Артхаус»). Добавлять произведения, категории и жанры может только администратор.<br>
Благодарные или возмущённые пользователи оставляют к произведениям текстовые отзывы и ставят произведению оценку в диапазоне от одного до десяти (целое число); из пользовательских оценок формируется усреднённая оценка произведения — рейтинг (целое число). На одно произведение пользователь может оставить только один отзыв.
Добавлять отзывы, комментарии и ставить оценки могут только аутентифицированные пользователи.
<br>

## Технологии
* Python 3.7
* Django 2.2.16
* Django Rest Framework 3.12.4
* Simple JWT 5.2.1
* PostgreSQL 13.0-alpine
* Nginx 1.21.3
* Gunicorn 20.0.4
* Docker 20.10.20
* Github Actions
<br>

## Запуск проекта:

__Docker__:

Проект запускается в изолированной среде с помощью системы контейнеризации.
Перед началом работы вам необходимо иметь установленный контейнизатор приложений Docker 19.03.0+, а также плагин docker compose 1.25.0+.

Проект включает:
- Приложение API,на WSGI-сервере Gunicorn;
- Сервер для  Nginx;
- База данных на основе PostgreSQL.

Каждый сервис запускается в отдельном контейнере.
Образы автоматически загружаются с DockerHub'a.
Dockerfile с конфигурацией образа для контейнера API лежит в папке *titles_api* и доступен для персональной конфигурации. Если вы решите использовать собственный образ, в файле *infra/docker-compose.yaml* строчку
```
image: rock4ts/infra-titles_api:latest
```
необходимо изменить на
```
build: ../titles_api
```

__Для запуска проекта:__

Скопируйте репозиторий на локальный компьютер:
```
git clone git@github.com:rock4ts/infra_sp2.git
```
Если проект запускается на удалённом сервере, в файле *nginx/default.conf* для переменной **server_name** укажите адрес данного сервера. Адрес также необходимо добавить в переменную **ALLOWED_HOSTS** в настройках Django проекта (файл *settings.py*)

Перейдите в папку с файлом docker-compose.yaml, __все последующие команды выполняйте из этой директории__:
```
cd <project_path>/infra/
```

Перед запуском сборки образов и создания контейнеров, в текущей директории необходимо создать файл .env и указать в нём переменные окружения согласно нижеуказанному примеру:
```
DB_ENGINE=django.db.backends.postgresql
DB_NAME=postgres
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres # установите свой пароль
DB_HOST=db
DB_PORT=5432

DEBUG=False
SECRET_KEY= # создайте и активируйте виртуальное окружение, установите модуль Django==2.2.28 и
сгенерируйте новый ключ. 
Для этого, находясь в папке backend/foodgram, в терминале
пропишите команду python manage.py shell и запустите следующий код:

from django.core.management.utils import get_random_secret_key  
get_random_secret_key()
```
Для сборки образов и создания контейнеров выполните команду: 
```
sudo docker compose up -d --build
```
Команда запустит файл *docker-compose.yaml*, соберёт образы, cоздаст контейнеры для каждого сервиса и свяжет с томами static_value и media_value директории Nginx и API с данными медиа-файлов и статики.

Теперь в контейнере с API (при сборке ему присвоено имя titles-api) необходимо выполнить миграции и собрать статику:
```
sudo docker compose exec titles-api python manage.py migrate
```
```
sudo docker compose exec titles-api python manage.py collectstatic --no-input 
```

В директории API-приложения содержится файл fixtures.json с тестовыми данными, для загрузки (по желанию) выполните следующие команды:
```
sudo docker compose exec titles-api python manage.py shell
```
```
# выполнить в открывшемся терминале:
>>> from django.contrib.contenttypes.models import ContentType
>>> ContentType.objects.all().delete()
>>> quit()
```

```
sudo docker compose exec titles-api python manage.py loaddata fixtures.json
```

Чтобы получить доступ к управлению базой данных через админ-зону, создайте суперпользователя:
```
sudo docker compose exec titles-api python manage.py createsuperuser
```
<br>

​Готово! 
Пример запущенного проекта можно посмотреть по данной ссылке:
[158.160.8.237/api/v1/](158.160.8.237/api/v1/)

#### Примечание:
Проект предусмотривает возможность автоматического заполнения таблиц данными csv-файлов.
Имя файла должно соответствовать названию заполняемой таблицы.
Загружаемые данные должны соответствовать форматам типов соответствующих полей моделей приложения.
Имя файла допускается как в единственном, так и множественном числе.
Для заполнения таблицы выполните команду:
```
sudo docker compose exec titles-api python manage.py populate_reviews --path <file_path>/<table_name>.csv
```
<br>

## Ресурсы API Titles
- Ресурс auth: аутентификация.
- Ресурс users: пользователи.
- Ресурс titles: произведения, к которым пишут отзывы (определённый фильм, книга или песенка).
- Ресурс categories: категории (типы) произведений («Фильмы», «Книги», «Музыка»).
- Ресурс genres: жанры произведений. Одно произведение может быть привязано к нескольким жанрам.
- Ресурс reviews: отзывы на произведения. Отзыв привязан к определённому произведению.
- Ресурс comments: комментарии к отзывам. Комментарий привязан к определённому отзыву.
<br>

__Детальная информация об эндпоинтах и правах доступа к API проекта доступна по ссылке__:
```
<your_server_name>/redoc/
```
